(()=>{var t={599:t=>{"use strict";t.exports=flarum.core.compat["mentions/fragments/PostQuoteButton"]}},e={};function n(r){var i=e[r];if(void 0!==i)return i.exports;var o=e[r]={exports:{}};return t[r](o,o.exports,n),o.exports}n.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return n.d(e,{a:e}),e},n.d=(t,e)=>{for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var r={};(()=>{"use strict";n.r(r);const t=flarum.core.compat["common/extend"],e=flarum.core.compat["common/app"];var i=n.n(e);const o=flarum.core.compat["common/components/Page"];var a=n.n(o);const c=flarum.core.compat["common/components/TextEditor"];var s=n.n(c);const l=flarum.core.compat["common/components/DiscussionPage"];var u=n.n(l);function p(t){return{inline:[t.inline.left,t.inline.right],display:[t.block.left,t.block.right]}}const h=function(t,e){for(var n=t.querySelectorAll(".katex-mathml + .katex-html"),r=0;r<n.length;r++){var i=n[r];i.remove?i.remove():i.parentNode&&i.parentNode.removeChild(i)}for(var o=t.querySelectorAll(".katex-mathml"),a=0;a<o.length;a++){var c=o[a],s=c.querySelector("annotation");s&&(c.replaceWith?c.replaceWith(s):c.parentNode&&c.parentNode.replaceChild(s,c),s.innerHTML=e.inline[0]+s.innerHTML+e.inline[1])}for(var l=t.querySelectorAll(".katex-display annotation"),m=0;m<l.length;m++){var u=l[m];u.innerHTML=e.display[0]+u.innerHTML.substr(e.inline[0].length,u.innerHTML.length-e.inline[0].length-e.inline[1].length)+e.display[1]}return t};function d(t,e){void 0===e&&(e=!1);var n={};return t.attribute("mathren.aliases_as_primary")&&!1===e?(n={inline:t.attribute("mathren.primary_inline_delimiter_alias"),block:t.attribute("mathren.primary_block_delimiter_alias")},t.attribute("mathren.allow_asciimath")&&(n.inline_asciimath=t.attribute("mathren.primary_inline_asciimath_delimiter_alias"),n.block_asciimath=t.attribute("mathren.primary_block_asciimath_delimiter_alias")),n):(n={inline:t.attribute("mathren.primary_inline_delimiter"),block:t.attribute("mathren.primary_block_delimiter")},t.attribute("mathren.allow_asciimath")&&(n.inline_asciimath=t.attribute("mathren.primary_inline_asciimath_delimiter"),n.block_asciimath=t.attribute("mathren.primary_block_asciimath_delimiter")),n)}function f(t){var e=t instanceof Element?t:t.parentElement;return e&&e.closest(".katex")}function v(t){var e=f(t.startContainer);e&&t.setStartBefore(e);var n=f(t.endContainer);n&&t.setEndAfter(n)}const b=flarum.core.compat["common/components/CommentPost"];var y=n.n(b);const _=flarum.core.compat["components/TextEditor"];var g=n.n(_);function x(t,e){return x=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},x(t,e)}const k=flarum.core.compat["common/components/Button"];var C=n.n(k);const w=flarum.core.compat["common/Component"];var A=n.n(w);const M=flarum.core.compat["common/components/Dropdown"];var S=n.n(M);const D=flarum.core.compat["common/components/Separator"];var E=n.n(D);const T=flarum.core.compat["common/utils/ItemList"];var B=n.n(T);const P=flarum.core.compat["common/helpers/icon"];var N=n.n(P);const O=flarum.core.compat["forum/components/DiscussionComposer"];var j=n.n(O);const q=flarum.core.compat["forum/components/EditPostComposer"];var L=n.n(q);const R=flarum.core.compat["forum/components/ReplyComposer"];var H=n.n(R);function I(){return[j(),L(),H()]}var W=function(t){var e,n;function r(){return t.apply(this,arguments)||this}n=t,(e=r).prototype=Object.create(n.prototype),e.prototype.constructor=e,x(e,n);var o=r.prototype;return o.oninit=function(e){this.isAsciiMath=!1,t.prototype.oninit.call(this,e)},o.oncreate=function(e){$(e.dom).find("label.checkbox").on("click",(function(t){t.stopPropagation()})),t.prototype.oncreate.call(this,e)},o.view=function(){return S().component({className:"MathRen-buttonsDropdown",buttonClassName:"Button Button--flat",label:N()("fas fa-square-root-alt")},this.items().toArray())},o.items=function(){var t=this,e=new(B());return e.add("mathren-blockButton",C().component({icon:"fas fa-vector-square",onclick:function(){return t.wrapSelection(!0)}},i().translator.trans("the-turk-mathren.forum.composer.block_expression"+(this.isAsciiMath?"_asciimath":""))),50),e.add("mathren-inlineButton",C().component({icon:"fas fa-grip-lines",onclick:function(){return t.wrapSelection()}},i().translator.trans("the-turk-mathren.forum.composer.inline_expression"+(this.isAsciiMath?"_asciimath":""))),0),i().forum.attribute("mathren.allow_asciimath")&&(e.add("mathren-separator",E().component()),e.add("mathren-asciiMath",m("label",{className:"checkbox"},m("input",{type:"checkbox",onchange:function(e){var n=e.target;t.isAsciiMath=n.checked,m.redraw.sync(),e.redraw=!1}}),i().translator.trans("the-turk-mathren.forum.composer.asciimath_only")))),e},o.wrapSelection=function(t){void 0===t&&(t=!1);var e=i().composer.body.componentClass;this.delimiters=d.bind(this,i().forum,-1===I().indexOf(e))();var n=t?this.isAsciiMath?this.delimiters.block_asciimath.left:this.delimiters.block.left:this.isAsciiMath?this.delimiters.inline_asciimath.left:this.delimiters.inline.left,r=t?this.isAsciiMath?this.delimiters.block_asciimath.right:this.delimiters.block.right:this.isAsciiMath?this.delimiters.inline_asciimath.right:this.delimiters.inline.right,o=this.attrs.textEditor.getSelectionRange();o[0]!=o[1]?(this.attrs.textEditor.insertAt(o[0],n),this.attrs.textEditor.insertAt(o[1]+n.length,r)):(this.attrs.textEditor.replaceBeforeCursor(o[0],n+r),this.attrs.textEditor.moveCursorTo(o[0]+n.length))},r}(A()),F=function(t,e,n){for(var r=n,i=0,o=t.length;r<e.length;){var a=e[r];if(i<=0&&e.slice(r,r+o)===t)return r;"\\"===a?r++:"{"===a?i++:"}"===a&&i--,r++}return-1},X=/^\\begin{/;var z=function(t,e){var n=function(t,e){for(var n,r=[],i=new RegExp("("+e.map((function(t){return t.left.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&")})).join("|")+")");-1!==(n=t.search(i));){n>0&&(r.push({type:"text",data:t.slice(0,n)}),t=t.slice(n));var o=e.findIndex((function(e){return t.startsWith(e.left)}));if(-1===(n=F(e[o].right,t,e[o].left.length)))break;var a=t.slice(0,n+e[o].right.length),c=X.test(a)?a:t.slice(e[o].left.length,n);r.push({type:"math",data:c,rawData:a,display:e[o].display,ascii:e[o].ascii}),t=t.slice(n+e[o].right.length)}return""!==t&&r.push({type:"text",data:t}),r}(t,e.splitAtDelimiters);if(1===n.length&&"text"===n[0].type)return null;for(var r=document.createDocumentFragment(),i=0;i<n.length;i++)if("text"===n[i].type)r.appendChild(document.createTextNode(n[i].data));else{var o=document.createElement("span"),a=n[i].data,c=!0===n[i].display,s=!0===n[i].ascii,l=c?s?e.primaryBlockAsciiMathDelimiter:e.primaryBlockDelimiter:s?e.primaryInlineAsciiMathDelimiter:e.primaryInlineDelimiter;o.textContent=l.left+a+l.right,r.appendChild(o)}return r};const Q=function t(e,n,r){for(var i=0;i<e.childNodes.length;i++){var o=e.childNodes[i];if(3===o.nodeType){var a=z(o.textContent,n);a&&(i+=a.childNodes.length-1,e.replaceChild(a,o))}else 1===o.nodeType&&t(o,n)}return!0===r?e.innerText:e};i().initializers.add("the-turk-mathren",(function(){var e=function(t,e,n){void 0===t&&(t=""),void 0===e&&(e=!1),void 0===n&&(n=!0);var r=document.createElement("span");return r.textContent=t,Q(r,o(e),n)},r=function(t){i().forum.attribute("mathren.aliases_as_primary")&&t.querySelectorAll("code").forEach((function(t){t.classList.contains("hljs")||(t.textContent=e(t.textContent,!0))}))},o=function(t){void 0===t&&(t=!1);var e=d.bind(void 0,i().forum,!t)(),n=i().forum.attribute("mathren.bbcode_delimiters"),r=i().forum.attribute("mathren.explicit_bbcode_delimiters"),o=i().forum.attribute("mathren.alias_delimiters"),a=t?n.concat(r):o,c={primaryBlockDelimiter:e.block,primaryInlineDelimiter:e.inline,splitAtDelimiters:a};return i().forum.attribute("mathren.allow_asciimath")&&(c.primaryBlockAsciiMathDelimiter=e.block_asciimath,c.primaryInlineAsciiMathDelimiter=e.inline_asciimath),c};(0,t.extend)(y().prototype,"oncreate",(function(){if("flarum-mentions"in flarum.extensions&&app.forum.attribute("mathren.enable_copy_tex")){var t=n(599),e=this.attrs.post,r=d.bind(this,app.forum)();if(!(e.isHidden()||app.session.user&&!e.discussion().canReply())){var i=this.$(".Post-body"),o=$('<div class="MathRen-quoteButtonContainer"></div>'),a=new t(e),c=function(t){setTimeout((function(){var e=function(t,e){var n=window.getSelection();if(!n.isCollapsed){var r=n.getRangeAt(0),i=r.commonAncestorContainer;if(t[0]===i||$.contains(t[0],i)){v(r);var o=r.cloneContents();o.querySelector(".katex-mathml")&&(o=h(o,e).textContent);var a=$("<div>").append(o);return a.find("img.emoji").replaceWith((function(){return this.alt})),a.find("img").replaceWith((function(){return"![]("+this.src+")"})),a.find("a").replaceWith((function(){return"["+this.innerText+"]("+this.href+")"})),a.text()}}return""}(i,p(r));if(e){a.content=e,m.render(o[0],a.render());var n=window.getSelection().getRangeAt(0).getClientRects(),c=n[0];if(t.clientY<c.bottom&&t.clientX-c.right<c.left-t.clientX)a.showStart(c.left,c.top);else{var s=n[n.length-1];a.showEnd(s.right,s.bottom)}}}),1)};this.$().after(o).on("mouseup",c),"ontouchstart"in window&&document.addEventListener("selectionchange",c,!1)}}})),(0,t.extend)(g().prototype,"toolbarItems",(function(t){!0===app.forum.attribute("mathren.enable_editor_buttons")&&t.add("the-turk-mathren",m(W,{textEditor:this.attrs.composer.editor}))})),(0,t.extend)(u().prototype,"oncreate",(function(){if(app.forum.attribute("mathren.enable_copy_tex")){var t=d.bind(this,app.forum)();document.addEventListener("copy",(function(e){var n=window.getSelection();if(!n.isCollapsed&&e.clipboardData){var r=e.clipboardData,i=n.getRangeAt(0);v(i);var o=i.cloneContents();if(o.querySelector(".katex-mathml")){var a=Array.prototype.map.call(o.childNodes,(function(t){return t instanceof Text?t.textContent:t.outerHTML})).join("");r.setData("text/html",a),r.setData("text/plain",h(o,p(t)).textContent),e.preventDefault()}}}))}})),(0,t.extend)(a().prototype,["oncreate","onupdate"],(function(){return r(document)})),s9e&&s9e.TextFormatter&&(0,t.override)(s9e.TextFormatter,"preview",(function(t,n,i){t(e(n),i),r(i)})),I().forEach((function(n){(0,t.override)(n.prototype,"onsubmit",(function(t){this.composer.fields.content(e(this.composer.fields.content())),t()}))})),(0,t.extend)(s().prototype,"oncreate",(function(t,n){var r=n.dom.querySelector("textarea"),o=i().composer.body.componentClass;if(-1===I().indexOf(o))r.addEventListener("input",(function(){r.value=e(r.value)}));else{if(!i().forum.attribute("mathren.aliases_as_primary"))return;r.value=e(this.value,!0)}}))}),-500)})(),module.exports=r})();
//# sourceMappingURL=forum.js.map